{% extends 'base.html' %}

{% block content %}



<section class="box">
    <h2>Payment Info</h2>
    <p>
        To fund light wallet scanning for this account, send any amount of Monero to the address below.
        The current price per block scanned is {{ config.PRICE_PICOS_PER_BLOCK }} piconeros per block ({{ config.PRICE_PICOS_PER_BLOCK | atomic }} XMR).
        To fund wallet scanning for 90 days (~{{ 720 * 90 }} blocks) it would cost ~{{ config.PRICE_PICOS_PER_BLOCK * 720 * 90 | atomic }} XMR.
    </p>
    <div id="qrcode"><img src="data:image/png;base64,{{ qrcode }}" width="200px"/></div>
    <p>
        Send funds to <span class="address">{{ account.payment_address }}</span>. 
        Transactions will appear below.
    </p>
</section>

<section id="gauge">
    <svg width="300" height="300" viewBox="0 0 400 400">
        <circle class="track" cx="200" cy="200" r="180"></circle>
        <circle class="progress-bar" id="progress-circle" cx="200" cy="200" r="180"></circle>
        <circle class="pulse-ring" cx="200" cy="200" r="50"></circle>
    </svg>
    <div class="labels">
        <p class="label-sub">Blocks Remaining</p>
        <h1 class="block-count" id="remaining-text">?</h1>
    </div>
</section>


<!-- 
# the current height is {height}
# this account started at height {account.start_height}
# {height - account.start_height} blocks have been mined since this account came online
# {total_sent} atomic xmr has been sent and is thus entitled to scan for {total_blocks_to_scan} total blocks
# the last block available for scanning will be {max_height}
# the scanning will continue for {remaining_blocks} more blocks
-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script>
        async function updateDashboard() {
            try {
                const res = await fetch("/api/account/{{ account.address }}/{{ account.view_key }}");
                const data = await res.json();
                // current_height
                // start_height
                // total_xmr_sent
                // total_blocks_to_scan
                // max_height
                // remaining_blocks
                const progressRatio = Math.min(Math.max(data.remaining_blocks / data.total_blocks_to_scan, 0), 1);
                const remainingBlocksText = document.getElementById('remaining-text').innerText;
                const progressCircle = document.getElementById('progress-circle');
                const circleLength = progressCircle.getTotalLength();
                const offset = circleLength - (progressRatio * circleLength);
                anime({
                    targets: '#progress-circle',
                    strokeDashArray: circleLength,
                    strokeDashoffset: [offset],
                    duration: 2000,
                    easing: 'easeOutQuart'
                });
                if (remainingBlocksText != data.remaining_blocks) {
                    anime({
                        targets: '#remaining-text',
                        innerText: [remainingBlocksText, data.remaining_blocks],
                        round: 1,
                        duration: 2000,
                        easing: 'easeOutQuart'
                    });
                }
            } catch(err) {
                console.log(err)
            }
        }
        anime({
            targets: '.pulse-ring',
            r: [20, 200],
            opacity: [.5, 0],
            duration: 4000,
            easing: 'easeOutExpo',
            loop: true
        });
        updateDashboard();
        setInterval(updateDashboard, 30 * 1_000);
    </script>


<h2>Pending Transactions</h2>
<ul>
{% for tx in pending_txes %}
<li><a href="https://xmrchain.net/tx/{{ tx.txid }}" target="_blank">{{ tx.txid | shorten }}</a> {{ tx.amount | atomic }} XMR ({{ tx.confirmations or 0 }} confirmations)</li>
{% endfor %}
</ul>

<h2>Completed Transactions</h2>
<ul>
{% for tx in completed_txes %}
<li><a href="https://xmrchain.net/tx/{{ tx.txid }}" target="_blank">{{ tx.txid | shorten }}</a> {{ tx.amount | atomic }} XMR ({{ tx.confirmations }} confirmations)</li>
{% endfor %}
</ul>

{% for payment in payments %}
{{ payment }}
{% endfor %}

<style>
    :root {
        --accent-color: #0a0e14;
        --secondary-color: #ff6600; /* Monero Orange */
        --text-color: #e0e0e0;
    }

    .address {
        user-select: all;
        word-wrap: anywhere;
        background-color: RGBA(255, 102, 0, .35) ;
    }

    #qrcode {
        text-align: center;
    }

    #gauge {
        position: relative;
        width: 400px;
        height: 400px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto;
    }

    svg {
        position: absolute;
        transform: rotate(-90deg);
    }

    .track {
        fill: none;
        stroke: #1a2634;
        stroke-width: 1;
    }

    .progress-bar {
        fill: none;
        stroke: var(--secondary-color);
        stroke-width: 6;
        stroke-linecap: round;
        stroke-dasharray: 1131; 
        stroke-dashoffset: 1131;
    }

    .pulse-ring {
        fill: none;
        stroke: var(--accent-color);
        stroke-width: 4;
        opacity: 0;
    }

    .labels {
        position: absolute;
        text-align: center;
        z-index: 10;
    }

    .block-count {
        font-size: 3.5rem;
        font-weight: bold;
        margin: 0;
    }
</style>

{% endblock %}